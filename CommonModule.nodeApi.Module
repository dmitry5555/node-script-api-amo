Процедура ОтправкаЗаказовВNodeJS_УНФ3()

    Сообщить("Starting...");
    URL = "https://amo122.hopto.org/api/orders";
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 20 " +
    "		Заказы.Ссылка КАК OrderRef, " +
    "       Заказы.Номер КАК OrderId, " +
    "       Заказы.Дата КАК OrderDate, " +
    "       Контрагент.Наименование КАК CustomerName, " +
    "       Контрагент.Код КАК CustomerId, " +
    "       Заказы.СуммаДокумента КАК Total " +
    "ИЗ " +
    "       Документ.ЗаказПокупателя КАК Заказы " +
    "       ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагент " +
    "       ПО Заказы.Контрагент = Контрагент.Ссылка " +
    "УПОРЯДОЧИТЬ ПО Заказы.Дата УБЫВ";

    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();

    Пока Выборка.Следующий() Цикл
        Попытка
            // Берём контакты (телефон и email) через КонтактнуюИнформацию
            Телефон = "";
            Email = "";
            КонтактнаяИнформация = Выборка.CustomerId.КонтактнаяИнформация;
            Для Каждого Контакт Из КонтактнаяИнформация Цикл
                Если Телефон = "" И Контакт.Вид = Перечисления.ВидыКонтактов.Телефон Тогда
                    Телефон = Контакт.Значение;
                КонецЕсли;
                Если Email = "" И Контакт.Вид = Перечисления.ВидыКонтактов.ЭлектроннаяПочта Тогда
                    Email = Контакт.Значение;
                КонецЕсли;
            КонецЦикла;

            // Формируем JSON
            ДанныеJSON = Новый Структура;
            ДанныеJSON.Вставить("orderId", СокрЛП(Выборка.OrderId));
            ДанныеJSON.Вставить("customerId", СокрЛП(Выборка.CustomerId));
            ДанныеJSON.Вставить("customerName", СокрЛП(Выборка.CustomerName));
            ДанныеJSON.Вставить("phone", СокрЛП(Телефон));
            ДанныеJSON.Вставить("email", СокрЛП(Email));
            ДанныеJSON.Вставить("total", Выборка.Total);
            ДанныеJSON.Вставить("orderDate", Формат(Выборка.OrderDate, "ДФ=yyyy-MM-dd'T'HH:mm:ss"));

            // Отправка HTTP POST
            HttpСоединение = Новый HTTPСоединение(URL, 30);
            ЗапросHTTP = HttpСоединение.СоздатьЗапрос("POST");
            ЗапросHTTP.УстановитьЗаголовок("Content-Type", "application/json");
            ЗаписьJSON = Новый ЗаписьJSON;
            ЗаписьJSON.УстановитьСтроку();
            ЗаписатьJSON(ЗаписьJSON, ДанныеJSON);
            ТелоЗапроса = ЗаписьJSON.Закрыть();
            ЗапросHTTP.УстановитьТелоИзСтроки(ТелоЗапроса);

            ОтветHTTP = HttpСоединение.Отправить(ЗапросHTTP);

            // Обработка ответа
            Если ОтветHTTP.КодСостояния = 200 Тогда
                Сообщить("Заказ " + ДанныеJSON.orderId + " успешно отправлен.");
            ИначеЕсли ОтветHTTP.КодСостояния = 409 Тогда
                Сообщить("Заказ " + ДанныеJSON.orderId + " уже существует (customerId: " + ДанныеJSON.customerId + ").");
            Иначе
                Сообщить("Ошибка при отправке заказа " + ДанныеJSON.orderId + ": " + ОтветHTTP.ПолучитьТелоКакСтроку());
            КонецЕсли;

        Исключение
            Сообщить("Ошибка HTTP при заказе " + СокрЛП(Выборка.OrderId) + ": " + ОписаниеОшибки());
        КонецПопытки;
    КонецЦикла;

КонецПроцедуры